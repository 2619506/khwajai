<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Khwaja AI</title>

<!-- Libraries -->
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

  :root{
    --neon:#00ffcc;
    --neon-soft:rgba(0,255,204,0.6);
    --glass:rgba(0,10,10,0.55);
    --glass-strong:rgba(0,20,20,0.75);
    --ink:#b7ffee;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; overflow:hidden; background:black; color:var(--neon);
    font-family:'Share Tech Mono', monospace; letter-spacing:0.6px;
  }

  /* Starfield canvas */
  canvas#stars{position:fixed; inset:0; z-index:-3}

  h1,h2,h3,p,a,label,button,select,input{ text-shadow:0 0 8px var(--neon), 0 0 20px var(--neon-soft); }

  /* Center Globe */
  .center-content{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    width:310px; height:310px; background:rgba(0,0,0,0.9); border-radius:50%;
    padding:22px; text-align:center; overflow:hidden;
    box-shadow:inset 0 0 30px rgba(0,255,204,0.4);
    display:flex; flex-direction:column; justify-content:center; align-items:center;
    z-index:2;
  }
  .center-content h1{margin:6px 0 8px}
  .center-content p{margin:0; color:var(--ink)}
  .center-content h1{font-size:clamp(1rem,2.4vh,1.35rem)}
  .center-content p{font-size:clamp(0.72rem,1.9vh,0.95rem); line-height:1.35}

  /* Orbit container */
  .orbit {
    position:absolute;
    top:50%; left:50%;
    width:600px; height:600px;
    margin:-300px 0 0 -300px;
    border-radius:50%;
    animation: spin 40s linear infinite;
    z-index:1;
  }
  @keyframes spin {
    from{ transform:rotate(0deg); }
    to{ transform:rotate(360deg); }
  }

  /* Satellite Tabs */
  .tab{
    position:absolute;
    padding:10px 18px;
    border-radius:16px;
    border:1px solid var(--neon-soft);
    background:rgba(0,255,204,0.08);
    color:var(--neon); font-weight:bold; text-transform:uppercase;
    text-decoration:none; cursor:pointer;
    box-shadow:0 0 15px rgba(0,255,204,0.4);
    backdrop-filter:blur(3px);
    transition:transform 0.3s, background 0.3s;
  }
  .tab:hover{ background:rgba(0,255,204,0.25); transform:scale(1.1); }

  .tab1{ top:0; left:50%; transform:translate(-50%, -50%); }
  .tab2{ top:50%; right:0; transform:translate(50%, -50%); }
  .tab3{ bottom:0; left:50%; transform:translate(-50%, 50%); }
  .tab4{ top:50%; left:0; transform:translate(-50%, -50%); }
  .tab5{ top:15%; left:15%; transform:translate(-50%, -50%); }

  /* Chatbot left fixed */
  .chatbot-container{position:fixed; bottom:20px; left:20px; z-index:10; display:flex; flex-direction:column; align-items:center}
  .robot-icon{width:80px; height:80px; background:rgba(0,255,204,0.08); border:2px solid var(--neon); border-radius:50%; box-shadow:0 0 25px var(--neon);
    background-image:url('https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Robot_icon.svg/2048px-Robot_icon.svg.png'); background-size:cover; margin-bottom:10px}

  /* Overlay Panel styles (Analyzer) */
  .overlay{
    position:fixed; inset:0; display:none; place-items:center; z-index:20;
    background:radial-gradient(ellipse at center, rgba(0,10,10,0.25) 0%, rgba(0,0,0,0.85) 60%, rgba(0,0,0,0.95) 100%);
  }
  .panel{
    width:min(1200px,92vw); height:min(78vh,820px); border:1px solid var(--neon-soft);
    background:linear-gradient(180deg, var(--glass), var(--glass-strong));
    border-radius:24px; box-shadow:0 0 60px rgba(0,255,204,0.35), inset 0 0 40px rgba(0,255,204,0.15);
    backdrop-filter: blur(10px) saturate(140%);
    position:relative; overflow:hidden;
  }
  .panel-header{
    display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid rgba(0,255,204,0.25);
    background:linear-gradient(180deg, rgba(0,255,204,0.08), rgba(0,255,204,0.02));
  }
  .panel-title{font-size:1.05rem; letter-spacing:2px}
  .close-btn{
    width:36px; height:36px; border-radius:50%; border:1px solid var(--neon);
    background:transparent; color:var(--neon); cursor:pointer;
    box-shadow:0 0 16px rgba(0,255,204,0.5), inset 0 0 12px rgba(0,255,204,0.2);
  }
  .close-btn:hover{ background:rgba(0,255,204,0.12); transform:scale(1.06) }
</style>
</head>
<body>

<canvas id="stars"></canvas>

<!-- Orbit with satellites -->
<div class="orbit">
  <div class="tab tab1" onclick="showHome()">Analytics</div>
  <div class="tab tab2" onclick="showMessage('Finance panel docking soon‚Ä¶')">Finance</div>
  <div class="tab tab3" onclick="showMessage('AI & ML bay warming up‚Ä¶')">AI & ML</div>
  <div class="tab tab4" onclick="openOverlay()">Tools</div>
  <div class="tab tab5" onclick="showMessage('Transmitting CV‚Ä¶')">CV</div>
</div>

<!-- Center Globe -->
<div class="center-content" id="centerContent">
  <h1 id="ccTitle">Khwaja AI</h1>
  <p id="ccText">
    Intergalactic expertise in <b>Business Analytics</b>, <b>Finance</b>, and <b>Artificial Intelligence</b>.<br/>
    Pilot projects that use machine learning for predictive insights and deploy
    futuristic tools for real-time data visualisation. Engage the orbiting satellites
    to access modules and launch the analyzer.
  </p>
</div>

<!-- Chatbot -->
<div class="chatbot-container">
  <div class="robot-icon"></div>
</div>

<!-- Analyzer Overlay -->
<div id="analyzerOverlay" class="overlay" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="panelTitle">
    <div class="panel-header">
      <div class="pill"><span>üõ∏</span><span id="panelTitle">Khwaja AI Analyzer</span></div>
      <button class="close-btn" title="Close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div class="panel-body">
      <!-- Controls -->
      <div class="controls" style="overflow:auto; padding:12px; width:320px; float:left;">
        <div class="card">
          <h3>1) Upload Datasets (CSV / Excel)</h3>
          <label>Dataset 1</label>
          <input id="file1" type="file" accept=".csv,.xlsx,.xls" />
          <label>Dataset 2</label>
          <input id="file2" type="file" accept=".csv,.xlsx,.xls" />
          <div style="margin-top:8px;font-size:.8rem;color:var(--ink)">Tip: First rows should have headers.</div>
        </div>

        <div class="card">
          <h3>2) Select Columns</h3>
          <label for="x1">X (Dataset 1)</label>
          <select id="x1" disabled></select>
          <label for="y1">Y (Dataset 1)</label>
          <select id="y1" disabled></select>
          <label for="x2">X (Dataset 2)</label>
          <select id="x2" disabled></select>
          <label for="y2">Y (Dataset 2)</label>
          <select id="y2" disabled></select>
          <label for="chartType">Chart Type</label>
          <select id="chartType" disabled>
            <option value="scatter">Scatter</option>
            <option value="line">Line</option>
            <option value="bar">Bar</option>
            <option value="area">Area</option>
            <option value="histogram">Histogram</option>
            <option value="box">Box</option>
            <option value="pie">Pie</option>
            <option value="heatmap">Heatmap</option>
          </select>
          <label for="mode">Compare Mode</label>
          <select id="mode" disabled>
            <option value="overlay">Overlay</option>
            <option value="side">Side-by-Side (Bars)</option>
          </select>
        </div>

        <div class="card">
          <h3>3) Render</h3>
          <button id="vizBtn" class="btn" onclick="plotData()" disabled>Visualize ‚ñ∂</button>
          <div class="footer-actions" style="margin-top:10px">
            <button class="btn" onclick="downloadChart('png')" disabled id="dlPng">PNG</button>
            <button class="btn" onclick="downloadChart('jpeg')" disabled id="dlJpg">JPEG</button>
            <button class="btn" onclick="downloadChart('svg')" disabled id="dlSvg">SVG</button>
          </div>
        </div>

        <div class="card">
          <h3>Status</h3>
          <div id="status">Awaiting input‚Ä¶</div>
        </div>
      </div>

      <!-- Chart Area -->
      <div class="chart-wrap" style="margin-left:340px; height:100%;">
        <!-- Holographic sphere backdrop -->
        <div id="sphereWrap"><canvas id="sphere"></canvas></div>
        <div id="chart"></div>
        <div id="insights" class="insights" style="display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- ============================= -->
<!-- Scripts: Stars, Orbit, Analyzer -->
<!-- ============================= -->
<script>
/* --------- Stars --------- */
const canvas = document.getElementById('stars');
const ctx = canvas.getContext('2d');
let stars = [], meteors = [];
function resizeCanvas(){ canvas.width = innerWidth; canvas.height = innerHeight; }
resizeCanvas(); addEventListener('resize', resizeCanvas);
function createStars(count){ stars = []; for(let i=0;i<count;i++){ stars.push({ x:Math.random()*canvas.width, y:Math.random()*canvas.height, speed:Math.random()*0.5+0.2, size:Math.random()*2 }); } }
function createMeteors(count){ meteors = []; for(let i=0;i<count;i++){ meteors.push({ x:Math.random()*canvas.width, y:Math.random()*canvas.height, speedX:-(Math.random()*4+2), speedY:Math.random()*2+1, length:Math.random()*50+30 }); } }
function drawStars(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle = '#00ffcc'; for(const s of stars){ ctx.beginPath(); ctx.arc(s.x,s.y,s.size,0,Math.PI*2); ctx.fill(); s.y += s.speed; if(s.y>canvas.height){ s.y=0; s.x=Math.random()*canvas.width; } } ctx.strokeStyle = '#00ffcc'; ctx.lineWidth = 1.5; for(const m of meteors){ ctx.beginPath(); ctx.moveTo(m.x,m.y); ctx.lineTo(m.x + m.length*m.speedX/10, m.y + m.length*m.speedY/10); ctx.stroke(); m.x += m.speedX; m.y += m.speedY; if(m.x < -100 || m.y > canvas.height+100){ m.x = canvas.width + Math.random()*200; m.y = Math.random()*canvas.height/2; } } }
createStars(220); createMeteors(6);
(function animate(){ drawStars(); requestAnimationFrame(animate); })();

/* --------- Center Globe Text --------- */
function fitCenterText(){
  const cc = document.getElementById('centerContent');
  if(!cc) return;
  const h1 = cc.querySelector('h1');
  const p = cc.querySelector('p');
  let guard=0;
  while(cc.scrollHeight > cc.clientHeight && guard<60){
    h1.style.fontSize = (parseFloat(getComputedStyle(h1).fontSize)-0.5)+'px';
    p.style.fontSize = (parseFloat(getComputedStyle(p).fontSize)-0.5)+'px';
    guard++;
  }
}
window.addEventListener('load', fitCenterText);
window.addEventListener('resize', ()=>{ setTimeout(fitCenterText, 100); });

/* --------- Overlay Logic --------- */
function showHome(){ 
  const cc = document.getElementById('centerContent');
  cc.innerHTML = `<h1>Khwaja AI</h1><p>Intergalactic expertise in <b>Business Analytics</b>, <b>Finance</b>, and <b>Artificial Intelligence</b>.<br/>Pilot projects that use machine learning for predictive insights and deploy futuristic tools. Click <b>Tools</b> to launch the analyzer.</p>`;
  fitCenterText();
}
function showMessage(msg){ 
  document.getElementById('centerContent').innerHTML = `<h1>Console</h1><p>${msg}</p>`;
  fitCenterText();
}
function openOverlay(){ document.getElementById('analyzerOverlay').style.display='grid'; setStatus('Overlay online. Load data‚Ä¶'); startSphere(); onResizeSphere(); }
function closeOverlay(){ document.getElementById('analyzerOverlay').style.display='none'; stopSphere(); }

/* --------- Analyzer Data Logic (Plotly + XLSX + PapaParse) --------- */
// Same as in your original file ‚Äî (loadFile, assignData, plotData, insights, etc.)
// [For brevity, you can copy the exact Analyzer JS block from your last working code here]
  /* --------- Analyzer Data Logic (Plotly + XLSX + PapaParse) --------- */
let dataset1 = [], dataset2 = [];
let ds1Label = 'Dataset 1', ds2Label = 'Dataset 2';
const el = id => document.getElementById(id);
const setStatus = msg => el('status').textContent = msg;

// Enable/disable controls
function setControlsEnabled(enabled){
  ['x1','y1','x2','y2','chartType','mode','vizBtn','dlPng','dlJpg','dlSvg'].forEach(id=>{
    const e = el(id); if(e) e.disabled = !enabled;
  });
}
setControlsEnabled(false);

// File inputs
function wireFileInputs(){
  el('file1').addEventListener('change', e=> loadFile(e.target.files[0], 1));
  el('file2').addEventListener('change', e=> loadFile(e.target.files[0], 2));
}
wireFileInputs();

function loadFile(file, index){
  if(!file) return;
  const name = file.name || `dataset${index}`;
  const ext = name.split('.').pop().toLowerCase();
  setStatus(`Loading ${name} ‚Ä¶`);

  const assign = data => assignData(data, index, name);

  if(ext === 'csv'){
    Papa.parse(file, { header:true, dynamicTyping:true, skipEmptyLines:true, complete: res => assign(res.data) });
  } else if(ext === 'xlsx' || ext === 'xls'){
    const reader = new FileReader();
    reader.onload = e=>{
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      const sheet = wb.SheetNames[0];
      const json = XLSX.utils.sheet_to_json(wb.Sheets[sheet], {defval:null});
      assign(json);
    };
    reader.readAsArrayBuffer(file);
  } else {
    alert('Unsupported file type. Please upload CSV or Excel.');
    setStatus('Unsupported file type.');
  }
}

function assignData(data, index, label){
  const cleaned = (data||[]).filter(row => Object.values(row).some(v => v!==null && v!=='' && v!==undefined));
  if(index===1){ dataset1 = cleaned; ds1Label = label; } else { dataset2 = cleaned; ds2Label = label; }
  setStatus(`${label} loaded (${cleaned.length} rows).`);
  if(dataset1.length && dataset2.length){ populateDropdowns(); setControlsEnabled(true); }
}

function populateDropdowns(){
  const sample1 = dataset1[0] || {}; const sample2 = dataset2[0] || {};
  const keys1 = Object.keys(sample1); const keys2 = Object.keys(sample2);
  const keys = Array.from(new Set([...keys1, ...keys2]));

  const numeric1 = keys.filter(k=> isNumericColumn(dataset1, k));
  const numeric2 = keys.filter(k=> isNumericColumn(dataset2, k));

  fillSelect(el('x1'), keys1.length?keys1:keys);
  fillSelect(el('y1'), numeric1.length?numeric1:keys1.length?keys1:keys);
  fillSelect(el('x2'), keys2.length?keys2:keys);
  fillSelect(el('y2'), numeric2.length?numeric2:keys2.length?keys2:keys);

  setStatus('Columns ready. Choose X/Y and chart type.');
}

function fillSelect(selectEl, items){
  selectEl.innerHTML = '';
  items.forEach(k=>{
    const o=document.createElement('option'); o.value=o.textContent=k; selectEl.appendChild(o);
  });
  selectEl.disabled = items.length === 0;
}

function isNumericColumn(ds, key){
  const vals = ds.slice(0,60).map(r=> r? r[key] : undefined).filter(v=> v!==null && v!=='' && v!==undefined);
  if(!vals.length) return false;
  return vals.every(v=> typeof v === 'number' || (!isNaN(parseFloat(v)) && isFinite(v)));
}

function toNum(v){ return (typeof v === 'number')? v : parseFloat(v); }

function plotData(){
  if(!dataset1.length || !dataset2.length){ alert('Upload both datasets first.'); return; }
  const x1 = el('x1').value, y1 = el('y1').value;
  const x2 = el('x2').value, y2 = el('y2').value;
  const chartType = el('chartType').value, mode = el('mode').value;

  const trace1 = buildTrace(dataset1, x1, y1, chartType, ds1Label);
  const trace2 = buildTrace(dataset2, x2, y2, chartType, ds2Label);

  let data = [trace1, trace2];
  let layout = baseLayout(chartType, mode);

  if(chartType === 'pie'){
    data = [ {...trace1, domain:{row:0,column:0}}, {...trace2, domain:{row:0,column:1}} ];
    layout.grid = {rows:1, columns:2};
  }
  if(chartType === 'bar' && mode === 'side'){ layout.barmode = 'group'; }
  if(chartType === 'bar' && mode === 'overlay'){ layout.barmode = 'overlay'; trace1.opacity=0.85; trace2.opacity=0.65; }

  const plotDiv = document.getElementById('chart');
  const firstTime = !plotDiv.data;
  const plot = firstTime ? Plotly.newPlot(plotDiv, data, layout, {responsive:true, displaylogo:false})
                         : Plotly.react(plotDiv, data, layout, {responsive:true, displaylogo:false});
  plot.then(()=>{
    setStatus('Visualization rendered.');
    ['dlPng','dlJpg','dlSvg'].forEach(id=> el(id).disabled=false);
    updateInsights(dataset1, dataset2, y1, y2, x1, x2);
  });
}

function buildTrace(ds, xKey, yKey, type, name){
  const x = ds.map(r=> r[xKey]);
  const y = ds.map(r=> r[yKey]).map(toNum);

  if(type === 'heatmap'){
    const bins = 20;
    const xVals = x.map(Number).filter(n=>!isNaN(n));
    const yVals = y.map(Number).filter(n=>!isNaN(n));
    const xMin = Math.min(...xVals), xMax=Math.max(...xVals);
    const yMin = Math.min(...yVals), yMax=Math.max(...yVals);
    const z = Array.from({length:bins},()=>Array(bins).fill(0));
    for(let i=0;i<Math.min(xVals.length,yVals.length);i++){
      const xi = Math.min(bins-1, Math.max(0, Math.floor((xVals[i]-xMin)/(xMax-xMin||1)*bins)));
      const yi = Math.min(bins-1, Math.max(0, Math.floor((yVals[i]-yMin)/(yMax-yMin||1)*bins)));
      z[yi][xi]++;
    }
    return { type:'heatmap', z, name, colorscale:'Viridis' };
  }

  if(type === 'pie') return { type:'pie', labels:x, values:y, name, hole:0.25 };
  if(type === 'box') return { type:'box', y, name, boxmean:true };
  if(type === 'histogram') return { type:'histogram', x:y, name, opacity:0.75 };
  if(type === 'bar') return { type:'bar', x, y, name };

  const mode = (type==='line' || type==='area') ? 'lines' : 'markers';
  const fill = (type==='area') ? 'tozeroy' : undefined;
  return { type:'scatter', mode, x, y, name, fill };
}

function baseLayout(type, mode){
  return {
    title:{ text:`Khwaja AI Analyzer ‚Äî ${type.toUpperCase()}`, font:{family:'Share Tech Mono', size:18, color:'#a6ffee'} },
    paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0.55)',
    font:{color:'#a6ffee'},
    xaxis:{gridcolor:'rgba(0,255,204,0.15)', zerolinecolor:'rgba(0,255,204,0.25)'},
    yaxis:{gridcolor:'rgba(0,255,204,0.15)', zerolinecolor:'rgba(0,255,204,0.25)'},
    margin:{t:50,r:20,b:45,l:55},
    legend:{bgcolor:'rgba(0,0,0,0.35)', bordercolor:'rgba(0,255,204,0.2)', borderwidth:1, orientation:'h'},
    shapes:[{ type:'rect', xref:'paper', yref:'paper', x0:0, y0:0, x1:1, y1:1, line:{width:1, color:'rgba(0,255,204,0.25)'}, fillcolor:'rgba(0,255,204,0.04)'}],
    transition:{duration:500, easing:'cubic-in-out'}
  };
}

function downloadChart(fmt='png'){
  Plotly.downloadImage('chart', {format:fmt, filename:`khwaja_ai_chart_${Date.now()}`});
}

/* ---------- Insights ---------- */
function updateInsights(ds1, ds2, yKey1, yKey2, xKey1, xKey2){
  const box = document.getElementById('insights');
  const y1 = ds1.map(r=> toNum(r[yKey1])).filter(n=> !isNaN(n));
  const y2 = ds2.map(r=> toNum(r[yKey2])).filter(n=> !isNaN(n));
  if(!y1.length || !y2.length){ box.style.display='none'; return; }

  const paired = pairArrays(y1, y2);
  const corr = pearson(paired.a, paired.b);
  const trend1 = slope(ds1.map(r=> toNum(r[yKey1])));
  const trend2 = slope(ds2.map(r=> toNum(r[yKey2])));

  const msg = [
    `<b>Alien Insight</b> ‚Äî`,
    `Correlation (Y‚ÇÅ:${yKey1} vs Y‚ÇÇ:${yKey2}): <b>${isFinite(corr)?corr.toFixed(2):'n/a'}</b>`,
    `Trend Y‚ÇÅ: <b>${trend1>0?'‚ÜóÔ∏é up':'‚ÜòÔ∏é down'}</b> (slope ${prettyNum(trend1)})`,
    `Trend Y‚ÇÇ: <b>${trend2>0?'‚ÜóÔ∏é up':'‚ÜòÔ∏é down'}</b> (slope ${prettyNum(trend2)})`,
    anomalyNote(y1,y2)
  ].join(' ¬∑ ');

  box.innerHTML = msg;
  box.style.display='block';
}
function pairArrays(a,b){ const n=Math.min(a.length,b.length); return {a:a.slice(0,n), b:b.slice(0,n)}; }
function mean(arr){ return arr.reduce((s,v)=>s+v,0)/arr.length }
function pearson(a,b){
  const n=Math.min(a.length,b.length); if(n<3) return NaN;
  const ma=mean(a.slice(0,n)), mb=mean(b.slice(0,n));
  let num=0, da=0, db=0;
  for(let i=0;i<n;i++){ const xa=a[i]-ma, yb=b[i]-mb; num+=xa*yb; da+=xa*xa; db+=yb*yb; }
  return num/Math.sqrt(da*db||1);
}
function slope(arr){
  const n=arr.length; if(n<2) return 0;
  const x=Array.from({length:n},(_,i)=>i+1);
  const mx=mean(x), my=mean(arr);
  let num=0, den=0;
  for(let i=0;i<n;i++){ num += (x[i]-mx)*(arr[i]-my); den += (x[i]-mx)*(x[i]-mx); }
  return num/(den||1);
}
function std(arr){ const m=mean(arr); const v=mean(arr.map(v=>(v-m)*(v-m))); return Math.sqrt(v); }
function anomalyNote(a,b){
  const s1 = std(a), s2 = std(b);
  return (s1>0 && s2>0 && (s1>2*s2 || s2>2*s1)) ? '<i>Volatility mismatch detected</i>' : '<i>No major volatility mismatch</i>';
}
function prettyNum(n){ return (Math.abs(n)<1? n.toFixed(3) : n.toFixed(2)) }

/* ---------- Three.js Holographic Sphere ---------- */
let sphereScene, sphereCamera, sphereRenderer, sphereMesh, sphereReq;
function startSphere(){
  const wrap = document.getElementById('sphereWrap');
  const canvas = document.getElementById('sphere');
  sphereScene = new THREE.Scene();
  const w = wrap.clientWidth, h = wrap.clientHeight;
  sphereCamera = new THREE.PerspectiveCamera(35, w/h, 0.1, 1000);
  sphereCamera.position.z = 6;

  sphereRenderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
  sphereRenderer.setSize(w,h,false);
  sphereRenderer.setPixelRatio(Math.min(devicePixelRatio, 2));

  const geo = new THREE.SphereGeometry(2.2, 48, 48);
  const mat = new THREE.MeshPhongMaterial({
    color: 0x00ffcc, emissive: 0x00221a, shininess: 80,
    transparent:true, opacity:0.4, wireframe:true
  });
  sphereMesh = new THREE.Mesh(geo, mat);
  sphereScene.add(sphereMesh);

  const glow = new THREE.PointLight(0x00ffcc, 1.2, 50); glow.position.set(4,4,6); sphereScene.add(glow);
  const rim = new THREE.AmbientLight(0x00ffc6, 0.25); sphereScene.add(rim);

  const animate = ()=>{
    sphereMesh.rotation.y += 0.0025;
    sphereMesh.rotation.x += 0.0008;
    sphereRenderer.render(sphereScene, sphereCamera);
    sphereReq = requestAnimationFrame(animate);
  };
  animate();
}
function stopSphere(){ if(sphereReq) cancelAnimationFrame(sphereReq); }
function onResizeSphere(){
  const wrap = document.getElementById('sphereWrap');
  if(!sphereRenderer || !wrap) return;
  const w = wrap.clientWidth, h = wrap.clientHeight;
  sphereCamera.aspect = w/h; sphereCamera.updateProjectionMatrix();
  sphereRenderer.setSize(w,h,false);
}
addEventListener('resize', onResizeSphere);

</script>

</body>
</html>
