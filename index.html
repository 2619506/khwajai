<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Khwaja AI | Intelligent Analytics</title>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500&display=swap');

  :root{
    /* --- NEW THEME: STARLIGHT & ROCK --- */
    --neon: #e2e8f0;               /* Starlight White/Silver */
    --neon-soft: rgba(226, 232, 240, 0.5); /* Soft White Glow */
    --rock-dark: #1e293b;          /* Dark Slate (Asteroid Shadow) */
    --rock-light: #475569;         /* Lighter Slate (Asteroid Highlight) */
    --glass: rgba(15, 23, 42, 0.6); /* Dark Blue-Grey Glass */
    --glass-strong: rgba(15, 23, 42, 0.85);
    --ink: #cbd5e1;                /* Soft Grey Text */
  }

  * { box-sizing:border-box; }
  html, body { height:100%; }
  body {
    margin: 0; overflow: hidden; background: #020617; /* Deepest Cosmic Blue/Black */
    color: var(--neon);
    font-family: 'Share Tech Mono', monospace; letter-spacing: 0.6px;
  }

  /* Starfield canvas */
  canvas#stars { position:fixed; inset:0; z-index:-3; }

  /* Global glow */
  h1,h2,h3,p,a,label,button,select,input { 
    text-shadow: 0 0 5px var(--neon-soft); 
  }

  /* Spaceship Wheel / Asteroid */
  .wheel {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) rotate(0deg);
    width: min(80vw, 500px); height: min(80vw, 500px); border-radius: 50%;
    
    /* ROCKY PLANET GRADIENT */
    background: radial-gradient(circle at 35% 35%, var(--rock-light) 0%, var(--rock-dark) 50%, #000000 100%);
    
    /* Subtle silver rim */
    border: 1px solid rgba(255, 255, 255, 0.15);
    
    /* Atmosphere glow */
    box-shadow: inset 0 0 80px rgba(0,0,0,0.8), 0 0 40px rgba(226, 232, 240, 0.15);
    z-index: 1;
  }

  /* Orbiting Alien Tabs */
  .tab {
    position: absolute;
    background: rgba(30, 41, 59, 0.4); /* Dark Slate Glass */
    border: 1px solid var(--neon-soft);
    padding: 12px 22px;
    border-radius: 50% / 40%;
    color: var(--neon);
    font-family: 'Orbitron', sans-serif;
    font-size: 0.95rem;
    letter-spacing: 2px;
    text-decoration: none;
    font-weight: bold;
    text-transform: uppercase;
    transition: background 0.3s, transform 0.3s, box-shadow 0.3s;
    cursor: pointer;
    backdrop-filter: blur(4px);
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
    user-select: none;
  }
  .tab:hover { 
    background: rgba(255, 255, 255, 0.1); 
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    transform: scale(1.1) translateX(-50%); 
  }
  
  /* Specific Tab Positions */
  .tab1 { top: -8%; left: 50%; transform: translateX(-50%); }
  .tab2 { top: 50%; right: -22%; transform: translateY(-50%); }
  .tab3 { bottom: -8%; left: 50%; transform: translateX(-50%); }
  .tab4 { top: 50%; left: -22%; transform: translateY(-50%); }
  .tab5 { bottom: -18%; left: 50%; transform: translateX(-50%); }

  /* Central Globe */
  .center-content {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
    width: 310px; height: 310px; background: none; 
    padding: 22px; text-align: center; overflow: hidden;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    pointer-events: none; /* Let clicks pass through to wheel if needed */
  }
  .center-content h1 { margin: 6px 0 8px; font-size: clamp(1rem, 2.4vh, 1.35rem); color: #fff; }
  .center-content p { margin: 0; color: var(--ink); font-size: clamp(0.72rem, 1.9vh, 0.95rem); line-height: 1.35; }

  /* Assistant Dock */
  .assistant-wrap {
    position: fixed; left: 14px; bottom: 15px; width: 58px; height: 58px;
    z-index: 9998; pointer-events: none;
  }
  .assistant-wrap::before {
    content: ""; position: absolute; inset: 0; border-radius: 50%;
    /* White/Blue Energy Core */
    background: radial-gradient(circle at center, rgba(255,255,255,0.9) 0%, rgba(139, 169, 219, 0.4) 40%, transparent 100%);
    box-shadow: 0 0 18px rgba(255,255,255,0.4);
    filter: blur(2px);
    animation: assistantGlow 4s ease-in-out infinite alternate;
    z-index: -1; pointer-events: none;
  }
  @keyframes assistantGlow {
    from { opacity: 0.65; transform: scale(0.95); }
    to   { opacity: 1; transform: scale(1.05); }
  }

  /* ========================= */
  /* ALIEN OVERLAY: ANALYZER   */
  /* ========================= */
  .overlay {
    position: fixed; inset: 0; display: none; place-items: center; z-index: 5;
    background: radial-gradient(ellipse at center, rgba(15, 23, 42, 0.4) 0%, rgba(2, 6, 23, 0.9) 80%);
    animation: fadeIn 300ms ease-out;
  }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .panel {
    width: min(1200px, 92vw); height: min(78vh, 820px); border: 1px solid var(--neon-soft);
    background: linear-gradient(180deg, var(--glass), var(--glass-strong));
    border-radius: 24px; box-shadow: 0 0 60px rgba(0,0,0,0.5), inset 0 0 40px rgba(255,255,255,0.05);
    backdrop-filter: blur(12px) saturate(110%);
    position: relative; overflow: hidden;
  }
  /* Grid lines overlay */
  .panel::before { content: ""; position: absolute; inset: 0; background: repeating-linear-gradient(to bottom, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 2px, transparent 2px, transparent 4px); pointer-events: none; }
  
  .panel-header {
    display: flex; align-items: center; justify-content: space-between; padding: 14px 18px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
  }
  .close-btn {
    width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--neon);
    background: transparent; color: var(--neon); cursor: pointer;
    box-shadow: 0 0 10px rgba(255,255,255,0.2);
    display: grid; place-items: center;
  }
  .close-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.06); }

  .panel-body { display: grid; grid-template-columns: 320px 1fr; gap: 16px; height: calc(100% - 62px); padding: 16px; }

  /* Controls Sidebar */
  .controls { overflow-y: auto; padding-right: 6px; }
  .controls::-webkit-scrollbar { width: 6px; }
  .controls::-webkit-scrollbar-thumb { background: var(--rock-light); border-radius: 3px; }

  .card {
    border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 12px; margin-bottom: 12px;
    background: rgba(15, 23, 42, 0.6); box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  }
  .card h3 { margin: 4px 0 10px; font-size: 0.95rem; letter-spacing: 1.5px; border-bottom: 1px dashed var(--neon-soft); padding-bottom: 5px; }

  label { display: block; font-size: 0.8rem; margin: 8px 0 4px; color: var(--ink); }
  input[type="file"], select, button {
    width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);
    background: rgba(0,0,0,0.4); color: var(--neon);
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
  }
  .btn { cursor: pointer; text-transform: uppercase; letter-spacing: 1.6px; font-weight: 700; transition: 0.2s; }
  .btn:hover { background: rgba(255,255,255,0.1); border-color: #fff; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  /* Chart Area */
  .chart-wrap { position: relative; height: 100%; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 8px; background: rgba(0,0,0,0.3); }
  #chart { width: 100%; height: 100%; border-radius: 12px; position: relative; z-index: 1; }

  /* Holographic Sphere */
  #sphereWrap { position: absolute; inset: 8px; border-radius: 12px; overflow: hidden; z-index: 0; pointer-events: none; }
  canvas#sphere { width: 100%; height: 100%; display: block; filter: drop-shadow(0 0 10px var(--neon-soft)); opacity: 0.6; }

  /* AI Insights Box */
  .insights {
    position: absolute; left: 16px; right: 16px; bottom: 16px; z-index: 2;
    background: rgba(15, 23, 42, 0.85); border: 1px solid rgba(255,255,255,0.2);
    border-radius: 12px; padding: 10px 12px; color: var(--ink); font-size: 0.85rem;
    backdrop-filter: blur(6px);
    animation: pulse 3s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 10px rgba(255,255,255,0.05); }
    50% { box-shadow: 0 0 20px rgba(255,255,255,0.15); }
  }

  .footer-actions { display: flex; gap: 10px; justify-content: flex-end; padding-top: 8px; }
  .pill { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.2); }

  /* Responsive */
  @media (max-width: 980px){
    .panel-body { grid-template-columns: 1fr; height: auto; overflow-y: auto; }
    .chart-wrap { height: 50vh; }
    .insights { position: static; margin-top: 10px; }
    #sphereWrap { display: none; } /* Hide heavy 3D on mobile for performance */
  }
</style>
</head>
<body>

<canvas id="stars"></canvas>

<div class="wheel" id="wheel">
  <div class="tab tab1" onclick="showHome()">Analytics</div>
  <div class="tab tab2" onclick="showMessage('Finance panel docking soonâ€¦')">Finance</div>
  <div class="tab tab3" onclick="showMessage('AI & ML bay warming upâ€¦')">AI & ML</div>
  <div class="tab tab4" onclick="openOverlay()">Tools</div>
  <div class="tab tab5" onclick="window.open('/portfolio/', '_blank')">Portfolio</div>

  <div class="center-content" id="centerContent">
    <h1 id="ccTitle">Khwaja AI</h1>
    <p id="ccText">
      Intergalactic expertise in <b>Business Analytics</b>, <b>Finance</b>, and <b>Artificial Intelligence</b>.<br/>
      Pilot projects that use machine learning for predictive insights. Engage the orbiting tabs to launch the analyzer.
    </p>
  </div>
</div>

<div class="assistant-wrap">
  <div class="assistant-hole" aria-label="AI Assistant Dock"></div>
</div>

<div id="analyzerOverlay" class="overlay" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="panelTitle">
    <div class="panel-header">
      <div class="pill"><span>ðŸ›¸</span><span id="panelTitle">Khwaja AI Analyzer</span></div>
      <button class="close-btn" title="Close" onclick="closeOverlay()">âœ•</button>
    </div>

    <div class="panel-body">
      <div class="controls">
        <div class="card">
          <h3>1) Upload Datasets</h3>
          <label>Dataset 1</label>
          <input id="file1" type="file" accept=".csv,.xlsx,.xls" />
          <label>Dataset 2</label>
          <input id="file2" type="file" accept=".csv,.xlsx,.xls" />
          <div style="margin-top:8px;font-size:.7rem;color:var(--ink)">*First row must contain headers</div>
        </div>

        <div class="card">
          <h3>2) Select Columns</h3>
          <div class="row">
            <div>
              <label for="x1">X (Set 1)</label>
              <select id="x1" disabled></select>
            </div>
            <div>
              <label for="y1">Y (Set 1)</label>
              <select id="y1" disabled></select>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="x2">X (Set 2)</label>
              <select id="x2" disabled></select>
            </div>
            <div>
              <label for="y2">Y (Set 2)</label>
              <select id="y2" disabled></select>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="chartType">Chart Type</label>
              <select id="chartType" disabled>
                <option value="scatter">Scatter</option>
                <option value="line">Line</option>
                <option value="bar">Bar</option>
                <option value="area">Area</option>
                <option value="histogram">Histogram</option>
                <option value="box">Box</option>
                <option value="pie">Pie</option>
                <option value="heatmap">Heatmap</option>
              </select>
            </div>
            <div>
              <label for="mode">Compare Mode</label>
              <select id="mode" disabled>
                <option value="overlay">Overlay</option>
                <option value="side">Side-by-Side</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>3) Render</h3>
          <button id="vizBtn" class="btn" onclick="plotData()" disabled>Visualize â–¶</button>
          <div class="footer-actions">
            <button class="btn" onclick="downloadChart('png')" disabled id="dlPng">PNG</button>
            <button class="btn" onclick="downloadChart('svg')" disabled id="dlSvg">SVG</button>
          </div>
        </div>

        <div class="card">
          <h3>Status</h3>
          <div id="status">Awaiting inputâ€¦</div>
        </div>
      </div>

      <div class="chart-wrap">
        <div id="sphereWrap"><canvas id="sphere"></canvas></div>

        <div id="chart"></div>
        <div id="insights" class="insights" style="display:none;"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  if(!window.chatbase || window.chatbase("getState")!=="initialized"){
    window.chatbase=(...arguments)=>{ if(!window.chatbase.q){window.chatbase.q=[]} window.chatbase.q.push(arguments) };
    window.chatbase=new Proxy(window.chatbase,{ get(target,prop){ if(prop==="q"){return target.q} return(...args)=>target(prop,...args) } });
  }
  const onLoad=function(){
    const script=document.createElement("script");
    script.src="https://www.chatbase.co/embed.min.js";
    script.id="85-fKKKuG65obFx8ejTz3"; // Khwaja ID
    script.domain="www.chatbase.co";
    document.body.appendChild(script);
  };
  if(document.readyState==="complete"){onLoad()} else { window.addEventListener("load", onLoad) }
})();
</script>

<script>
/* Attempt to move Chatbase bubble into the custom Neon Dock */
window.addEventListener("load", function(){
  setTimeout(()=>{
    const bubble = document.querySelector("#chatbase-bubble, iframe[src*='chatbase']");
    if(bubble){
      bubble.style.position = "absolute";
      bubble.style.bottom = "50%";
      bubble.style.left = "50%";
      bubble.style.transform = "translate(-50%, 50%) scale(0.9)";
      bubble.style.zIndex = "12";
      document.querySelector(".assistant-wrap").appendChild(bubble);
    }
  }, 2500); // Increased timeout to ensure render
});
</script>

<script>
/* STARFIELD: Updated to White Stars (Realistic Space) */
const canvas = document.getElementById('stars');
const ctx = canvas.getContext('2d');
let stars = [], meteors = [];

function resizeCanvas(){ canvas.width = innerWidth; canvas.height = innerHeight; }
resizeCanvas(); addEventListener('resize', resizeCanvas);

function createStars(count){ 
  stars = []; 
  for(let i=0;i<count;i++){ stars.push({ x:Math.random()*canvas.width, y:Math.random()*canvas.height, speed:Math.random()*0.3+0.1, size:Math.random()*1.8 }); } 
}

function createMeteors(count){ 
  meteors = []; 
  for(let i=0;i<count;i++){ meteors.push({ x:Math.random()*canvas.width, y:Math.random()*canvas.height, speedX:-(Math.random()*4+2), speedY:Math.random()*2+1, length:Math.random()*50+30 }); } 
}

function drawStars(){ 
  ctx.clearRect(0,0,canvas.width,canvas.height); 
  ctx.fillStyle = '#ffffff'; // PURE WHITE STARS
  for(const s of stars){ 
    ctx.beginPath(); ctx.arc(s.x,s.y,s.size,0,Math.PI*2); ctx.fill(); 
    s.y += s.speed; 
    if(s.y>canvas.height){ s.y=0; s.x=Math.random()*canvas.width; } 
  } 
  ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 1.0; 
  for(const m of meteors){ 
    ctx.beginPath(); ctx.moveTo(m.x,m.y); ctx.lineTo(m.x + m.length*m.speedX/10, m.y + m.length*m.speedY/10); ctx.stroke(); 
    m.x += m.speedX; m.y += m.speedY; 
    if(m.x < -100 || m.y > canvas.height+100){ m.x = canvas.width + Math.random()*200; m.y = Math.random()*canvas.height/2; } 
  } 
}

createStars(250); createMeteors(4);
(function animate(){ drawStars(); requestAnimationFrame(animate); })();
</script>

<script>
// Wheel Rotate
const wheel = document.getElementById('wheel');
document.addEventListener('mousemove', e=>{ 
  const centerX = innerWidth/2; const offsetX = e.clientX - centerX; 
  const rotation = offsetX/30; 
  wheel.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`; 
});

// Text Fitter
function fitCenterText(){
  const cc = document.getElementById('centerContent');
  const h1 = cc.querySelector('h1');
  const p = cc.querySelector('p');
  if(!h1 || !p) return;
  let hSize = parseFloat(getComputedStyle(h1).fontSize);
  let pSize = parseFloat(getComputedStyle(p).fontSize);
  let guard=0;
  while((cc.scrollHeight > cc.clientHeight) && guard<60){
    hSize = Math.max(12, hSize - 0.5); pSize = Math.max(10, pSize - 0.5);
    h1.style.fontSize = hSize + 'px'; p.style.fontSize = pSize + 'px';
    guard++;
  }
}
window.addEventListener('load', fitCenterText);
window.addEventListener('resize', ()=>{ setTimeout(fitCenterText, 100); });

// Navigation logic
function showHome(){
  const cc = document.getElementById('centerContent');
  cc.innerHTML = `<h1>Khwaja AI</h1><p>Intergalactic expertise in <b>Business Analytics</b>, <b>Finance</b>, and <b>Artificial Intelligence</b>.<br/>Pilot projects that use machine learning for predictive insights. Click <b>Tools</b> to launch the analyzer.</p>`;
  fitCenterText();
}
function showMessage(msg){ 
  const cc = document.getElementById('centerContent'); 
  cc.innerHTML = `<h1>Console</h1><p>${msg}</p>`; 
  fitCenterText(); 
}

function openOverlay(){ 
  document.getElementById('analyzerOverlay').style.display = 'grid'; 
  setStatus('Overlay online. Load data to beginâ€¦'); 
  startSphere(); onResizeSphere(); 
}
function closeOverlay(){ 
  document.getElementById('analyzerOverlay').style.display = 'none'; 
  stopSphere(); 
}

// Data Analyzer Logic
let dataset1 = [], dataset2 = [];
let ds1Label = 'Dataset 1', ds2Label = 'Dataset 2';
const el = id => document.getElementById(id);
const setStatus = msg => el('status').textContent = msg;

function setControlsEnabled(enabled){
  ['x1','y1','x2','y2','chartType','mode','vizBtn','dlPng','dlSvg'].forEach(id=>{
    const e = el(id); if(e){ e.disabled = !enabled; }
  });
}
setControlsEnabled(false);

// File Inputs
el('file1').addEventListener('change', e=> loadFile(e.target.files[0], 1));
el('file2').addEventListener('change', e=> loadFile(e.target.files[0], 2));

function loadFile(file, index){
  if(!file){ return; }
  const name = file.name || `dataset${index}`;
  const ext = name.split('.').pop().toLowerCase();
  setStatus(`Loading ${name} â€¦`);
  
  const assign = data => assignData(data, index, name);

  if(ext === 'csv'){
    Papa.parse(file, { header:true, dynamicTyping:true, skipEmptyLines:true, complete: res => assign(res.data) });
  } else if(ext === 'xlsx' || ext === 'xls'){
    const reader = new FileReader();
    reader.onload = e=>{
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      const sheet = wb.SheetNames[0];
      const json = XLSX.utils.sheet_to_json(wb.Sheets[sheet], {defval:null});
      assign(json);
    };
    reader.readAsArrayBuffer(file);
  } else {
    setStatus('Error: Unsupported file type.');
  }
}

function assignData(data, index, label){
  // Filter empty rows
  const cleaned = (data||[]).filter(row => Object.values(row).some(v => v!==null && v!=='' && v!==undefined));
  if(index===1){ dataset1 = cleaned; ds1Label = label; } else { dataset2 = cleaned; ds2Label = label; }
  setStatus(`${label} loaded (${cleaned.length} rows).`);
  
  // If both loaded or just one, try populating
  if(dataset1.length && dataset2.length){ 
    populateDropdowns(); 
    setControlsEnabled(true); 
  }
}

function populateDropdowns(){
  const sample1 = dataset1[0] || {}; const sample2 = dataset2[0] || {};
  const keys1 = Object.keys(sample1); const keys2 = Object.keys(sample2);
  const keys = Array.from(new Set([...keys1, ...keys2]));

  const numeric1 = keys.filter(k=> isNumericColumn(dataset1, k));
  const numeric2 = keys.filter(k=> isNumericColumn(dataset2, k));

  fillSelect(el('x1'), keys1.length?keys1:keys);
  fillSelect(el('y1'), numeric1.length?numeric1:keys1.length?keys1:keys);
  fillSelect(el('x2'), keys2.length?keys2:keys);
  fillSelect(el('y2'), numeric2.length?numeric2:keys2.length?keys2:keys);

  setStatus('Ready to Render.');
}

function fillSelect(selectEl, items){
  selectEl.innerHTML = '';
  items.forEach(k=>{ const o=document.createElement('option'); o.value=o.textContent=k; selectEl.appendChild(o); });
  selectEl.disabled = items.length === 0;
}

function isNumericColumn(ds, key){
  const vals = ds.slice(0,60).map(r=> r? r[key] : undefined).filter(v=> v!==null && v!=='' && v!==undefined);
  if(!vals.length) return false;
  return vals.every(v=> typeof v === 'number' || (!isNaN(parseFloat(v)) && isFinite(v)));
}

function toNum(v){ return (typeof v === 'number')? v : parseFloat(v); }

// Visualization
function plotData(){
  if(!dataset1.length || !dataset2.length){ alert('Please upload two datasets.'); return; }
  const x1 = el('x1').value; const y1 = el('y1').value;
  const x2 = el('x2').value; const y2 = el('y2').value;
  const chartType = el('chartType').value; const mode = el('mode').value;

  const trace1 = buildTrace(dataset1, x1, y1, chartType, ds1Label);
  const trace2 = buildTrace(dataset2, x2, y2, chartType, ds2Label);

  let data = [trace1, trace2];
  let layout = baseLayout(chartType, mode);

  if(chartType === 'pie'){
    data = [ {...trace1, domain:{row:0,column:0}}, {...trace2, domain:{row:0,column:1}} ];
    layout.grid = {rows:1, columns:2};
  }
  if(chartType === 'bar' && mode === 'side'){ layout.barmode = 'group'; }
  if(chartType === 'bar' && mode === 'overlay'){ layout.barmode = 'overlay'; trace1.opacity=0.85; trace2.opacity=0.65; }

  const plotDiv = document.getElementById('chart');
  // React uses existing DOM to update smoothly
  const firstTime = !plotDiv.data;
  const plot = firstTime ? Plotly.newPlot(plotDiv, data, layout, {responsive:true, displaylogo:false})
                         : Plotly.react(plotDiv, data, layout, {responsive:true, displaylogo:false});
  
  plot.then(()=>{
    setStatus('Visualization complete.');
    updateInsights(dataset1, dataset2, y1, y2);
  });
}

function buildTrace(ds, xKey, yKey, type, name){
  const x = ds.map(r=> r[xKey]);
  const y = ds.map(r=> r[yKey]).map(toNum);

  if(type === 'heatmap'){
    const bins = 20; 
    // Basic 2D histogram simulation for heatmap
    // Note: For true heatmaps, Plotly usually expects Z matrix. This is a simplified binning.
    return { type: 'histogram2d', x: x, y: y, name: name, colorscale:'Viridis' };
  }
  if(type === 'pie') return { type:'pie', labels:x, values:y, name, hole:0.25 };
  if(type === 'box') return { type:'box', y, name, boxmean:true };
  if(type === 'histogram') return { type:'histogram', x:y, name, opacity:0.75 };
  if(type === 'bar') return { type:'bar', x, y, name };

  const mode = (type==='line' || type==='area') ? 'lines' : 'markers';
  const fill = (type==='area') ? 'tozeroy' : undefined;
  return { type:'scatter', mode, x, y, name, fill };
}

function baseLayout(type, mode){
  return {
    title:{ text:`Khwaja AI Analyzer â€” ${type.toUpperCase()}`, font:{family:'Share Tech Mono', size:18, color:'#e2e8f0'} },
    paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(15, 23, 42, 0.4)',
    font:{color:'#e2e8f0'},
    xaxis:{gridcolor:'rgba(255,255,255,0.1)', zerolinecolor:'rgba(255,255,255,0.2)'},
    yaxis:{gridcolor:'rgba(255,255,255,0.1)', zerolinecolor:'rgba(255,255,255,0.2)'},
    margin:{t:50,r:20,b:45,l:55},
    legend:{bgcolor:'rgba(0,0,0,0.35)', bordercolor:'rgba(255,255,255,0.2)', borderwidth:1, orientation:'h'},
    transition:{duration:500, easing:'cubic-in-out'}
  };
}

function downloadChart(fmt='png'){
  Plotly.downloadImage('chart', {format:fmt, filename:`khwaja_ai_chart_${Date.now()}`});
}

/* Insights Engine */
function updateInsights(ds1, ds2, yKey1, yKey2){
  const box = document.getElementById('insights');
  const y1 = ds1.map(r=> toNum(r[yKey1])).filter(n=> !isNaN(n));
  const y2 = ds2.map(r=> toNum(r[yKey2])).filter(n=> !isNaN(n));
  if(!y1.length || !y2.length){ box.style.display='none'; return; }

  const paired = pairArrays(y1, y2);
  const corr = pearson(paired.a, paired.b);
  const trend1 = slope(y1);
  const trend2 = slope(y2);

  const msg = [
    `<b>Alien Insight</b> â€”`,
    `Correlation: <b>${isFinite(corr)?corr.toFixed(2):'n/a'}</b>`,
    `Trend 1: <b>${trend1>0?'â†—ï¸Ž up':'â†˜ï¸Ž down'}</b>`,
    `Trend 2: <b>${trend2>0?'â†—ï¸Ž up':'â†˜ï¸Ž down'}</b>`,
  ].join(' Â· ');

  box.innerHTML = msg;
  box.style.display='block';
}

// Math Helpers
function pairArrays(a,b){ const n = Math.min(a.length,b.length); return {a:a.slice(0,n), b:b.slice(0,n)}; }
function mean(arr){ return arr.reduce((s,v)=>s+v,0)/arr.length }
function pearson(a,b){
  const n=Math.min(a.length,b.length); if(n<3) return NaN;
  const ma=mean(a.slice(0,n)), mb=mean(b.slice(0,n));
  let num=0, da=0, db=0;
  for(let i=0;i<n;i++){ const xa=a[i]-ma, yb=b[i]-mb; num+=xa*yb; da+=xa*xa; db+=yb*yb; }
  return num/Math.sqrt(da*db||1);
}
function slope(arr){
  const n=arr.length; if(n<2) return 0;
  const x=Array.from({length:n},(_,i)=>i+1);
  const mx=mean(x), my=mean(arr);
  let num=0, den=0;
  for(let i=0;i<n;i++){ num += (x[i]-mx)*(arr[i]-my); den += (x[i]-mx)*(x[i]-mx); }
  return num/(den||1);
}

/* Three.js Holographic Sphere - UPDATED COLOR (Rock/Silver) */
let sphereScene, sphereCamera, sphereRenderer, sphereMesh, sphereReq;
function startSphere(){
  const wrap = document.getElementById('sphereWrap');
  const canvas = document.getElementById('sphere');
  sphereScene = new THREE.Scene();
  const w = wrap.clientWidth, h = wrap.clientHeight;
  sphereCamera = new THREE.PerspectiveCamera(35, w/h, 0.1, 1000);
  sphereCamera.position.z = 6;

  sphereRenderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
  sphereRenderer.setSize(w,h,false);
  sphereRenderer.setPixelRatio(Math.min(devicePixelRatio, 2));

  const geo = new THREE.SphereGeometry(2.2, 48, 48);
  const mat = new THREE.MeshPhongMaterial({ 
    color: 0x94a3b8,        /* Rock Grey */
    emissive: 0x0f172a,     /* Dark Shadow */
    shininess: 30, 
    transparent:true, 
    opacity:0.6, 
    wireframe:true 
  });
  sphereMesh = new THREE.Mesh(geo, mat);
  sphereScene.add(sphereMesh);

  const glow = new THREE.PointLight(0xffffff, 1.0, 50);
  glow.position.set(4,4,6);
  sphereScene.add(glow);
  sphereScene.add(new THREE.AmbientLight(0xffffff, 0.3));

  const animate = ()=>{
    sphereMesh.rotation.y += 0.0025; sphereMesh.rotation.x += 0.0008;
    sphereRenderer.render(sphereScene, sphereCamera);
    sphereReq = requestAnimationFrame(animate);
  };
  animate();
}
function stopSphere(){ if(sphereReq) cancelAnimationFrame(sphereReq); }
function onResizeSphere(){
  const wrap = document.getElementById('sphereWrap');
  if(!sphereRenderer || !wrap) return;
  const w = wrap.clientWidth, h = wrap.clientHeight;
  sphereCamera.aspect = w/h; sphereCamera.updateProjectionMatrix();
  sphereRenderer.setSize(w,h,false);
}
addEventListener('resize', onResizeSphere);
</script>

</body>
</html>
